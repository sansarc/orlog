import { describe, it, expect, beforeEach, vi } from 'vitest';
import { DieFace } from "../../dice/DieFace.ts";
import { BaldrsInvulnerability } from "../BaldrsInvulnerability.ts";
import {createMockDie} from "../../../utils/testUtils.ts";

vi.mock('../../Game.ts', () => ({
    Game: {
        Notifier: {
            info: vi.fn()
        }
    }
}));

describe("Baldr's Invulnerability", () => {
    let favor: BaldrsInvulnerability;
    let owner: any;
    let opponent: any;

    beforeEach(() => {
        favor = new BaldrsInvulnerability();
        owner = { name: "P1", dice: [] };
        opponent = { name: "P2" };
    });

    it('identifies as PRE_COMBAT', () => {
        expect(favor.priority).toBe('PRE_COMBAT');
    });

    it('Level 1: Adds 1 defense to each Shield and Helmet', () => {
        // SETUP: Owner has 2 Shields and 1 Helmet
        const d1 = createMockDie(DieFace.SHIELD);
        const d2 = createMockDie(DieFace.SHIELD);
        const d3 = createMockDie(DieFace.HELMET);
        const d4 = createMockDie(DieFace.AXE);

        owner.dice = [d1, d2, d3, d4];

        // ACT
        favor.execute(owner, opponent, 1);

        // ASSERT
        expect(d1.addDefense).toHaveBeenCalledWith(1);
        expect(d2.addDefense).toHaveBeenCalledWith(1);
        expect(d3.addDefense).toHaveBeenCalledWith(1);
        expect(d4.addDefense).not.toHaveBeenCalled(); // Axes ignored
    });

    it('Level 2: Adds 2 defense to each Shield and Helmet', () => {
        // SETUP: Owner has 1 Shield and 2 Helmets
        const d1 = createMockDie(DieFace.SHIELD);
        const d2 = createMockDie(DieFace.HELMET);
        const d3 = createMockDie(DieFace.HELMET);

        owner.dice = [d1, d2, d3];

        // ACT
        favor.execute(owner, opponent, 2);

        // ASSERT
        expect(d1.addDefense).toHaveBeenCalledWith(2);
        expect(d2.addDefense).toHaveBeenCalledWith(2);
        expect(d3.addDefense).toHaveBeenCalledWith(2);
    });

    it('Level 3: Adds 3 defense to each Shield and Helmet', () => {
        // SETUP: Owner has 1 Shield
        const d1 = createMockDie(DieFace.SHIELD);

        owner.dice = [d1];

        // ACT
        favor.execute(owner, opponent, 3);

        // ASSERT
        expect(d1.addDefense).toHaveBeenCalledWith(3);
    });

    it('Ignores resolved defenses', () => {
        // SETUP: Owner has a resolved Shield
        const d1 = createMockDie(DieFace.SHIELD, true); // Already resolved
        const d2 = createMockDie(DieFace.HELMET);

        owner.dice = [d1, d2];

        // ACT
        favor.execute(owner, opponent, 1);

        // ASSERT
        expect(d1.addDefense).not.toHaveBeenCalled(); // Resolved, ignored
        expect(d2.addDefense).toHaveBeenCalledWith(1);
    });

    it('Does nothing if no defenses exist', () => {
        // SETUP: Owner is aggressive (All Axes)
        const d1 = createMockDie(DieFace.AXE);
        const d2 = createMockDie(DieFace.ARROW);

        owner.dice = [d1, d2];

        // ACT
        favor.execute(owner, opponent, 1);

        // ASSERT
        expect(d1.addDefense).not.toHaveBeenCalled();
        expect(d2.addDefense).not.toHaveBeenCalled();
    });
});
